# D3: Dependency & Regression Audit Findings

**Auditor**: D3 (Dependency Auditor)
**Date**: 2026-02-26
**Scope**: CVEs in dependencies, lock file status, abandoned packages, version pinning, supply chain security

---

## Summary

| Category | Count |
|---|---|
| CRITICAL findings | 0 |
| HIGH findings | 1 |
| MEDIUM findings | 7 |
| LOW findings | 5 |
| SAFE/INFO | 3 |

**Python dependency count (production)**: 24 packages (in `[project.dependencies]`)
**Python lock file status**: PARTIAL — `requirements.lock` present but NOT a standard tool lock file; no `poetry.lock`, `Pipfile.lock`; `pyproject.toml` uses range-based specifiers
**Node.js direct dependency count**: 34 (20 production, 14 dev in `frontend/`); 1 dev dep in root
**Node.js lock file status**: PRESENT — `frontend/package-lock.json` (lockfileVersion 3, 613 integrity hashes); root `package-lock.json` (4 integrity hashes)
**Docker images**: 7 services; 6 use pinned tags; 1 uses untagged `:latest` equivalent

---

## Findings

### [HIGH] DEPENDENCY-MANAGEMENT: Python Lock File Not Authoritative for Builds

**File**: `pyproject.toml:19-53` and `requirements.lock:1-163`
**Agent**: D3 (Dependency Auditor)
**Evidence**:
```toml
# pyproject.toml — all production deps use range specifiers, NOT exact pins
"fastapi>=0.115.0,<1.0",
"sqlalchemy[asyncio]>=2.0.36,<3.0",
"pydantic>=2.10.0,<3.0",
"cryptography>=42.0.0,<44.0",
```
```
# requirements.lock header — generated by uv, not enforced by installer
# This file was autogenerated by uv via the following command:
#    uv pip compile pyproject.toml -o requirements.lock
fastapi==0.115.0
```
**Description**: `pyproject.toml` declares all production dependencies with range specifiers (`>=x.y,<z`). A `requirements.lock` file generated by `uv pip compile` is present but it is NOT committed as a `poetry.lock` or `Pipfile.lock`, and the Dockerfile installs from `pyproject.toml` directly via `pip install --no-cache-dir --prefix=/install "."` rather than from the lock file. This means Docker builds will resolve dependency versions at build time, not from the lock file.
**Risk**: Non-deterministic Docker builds. A new release within a declared range (e.g., `fastapi==0.125.0`) could be pulled into a production container without a code review. For security-sensitive packages like `cryptography` and `PyJWT`, this is a supply-chain integrity risk.
**Recommendation**: Update `Dockerfile.backend:17` to install from the lock file: `pip install --no-cache-dir -r requirements.lock`. Commit the lock file to source control and regenerate it via `uv pip compile pyproject.toml -o requirements.lock` before every dependency change.

---

### [MEDIUM] VERSION-PINNING: All Frontend Dependencies Use Caret Ranges

**File**: `frontend/package.json:20-58`
**Agent**: D3 (Dependency Auditor)
**Evidence**:
```json
"next": "15.5.10",
"react": "18.3.0",
"react-dom": "18.3.0",
"bpmn-js": "^18.12.0",
"cytoscape": "^3.33.1",
"recharts": "^3.7.0"
```
**Description**: Most frontend dependencies use the `^` caret operator (e.g., `"bpmn-js": "^18.12.0"`, `"cytoscape": "^3.33.1"`). While `next`, `react`, and `react-dom` are already pinned to exact versions (no `^`), the majority of dependencies are not. The `package-lock.json` does record resolved exact versions and contains SHA-512 integrity hashes for all 613 packages, which provides determinism when `npm ci` is used. The risk is that the lock file is the only enforcement mechanism.
**Risk**: Medium. If `package-lock.json` is ever deleted or not committed, `npm install` will float all caret-ranged packages to the latest compatible version. This is especially relevant for `bpmn-js` which has a non-standard license restriction (see bpmn-js finding below).
**Recommendation**: Document that `npm ci` (not `npm install`) is mandatory in all build environments. For security-sensitive direct dependencies, consider removing `^` from `package.json` as a belt-and-suspenders measure.

---

### [MEDIUM] DEPENDENCY-CATEGORIZATION: Build-time Packages in Production Dependencies

**File**: `frontend/package.json:25-26,33,38-39`
**Agent**: D3 (Dependency Auditor)
**Evidence**:
```json
"dependencies": {
  "@tailwindcss/postcss": "^4.1.18",
  "postcss": "^8.5.6",
  "tailwindcss": "^4.1.18",
  "tailwindcss-animate": "^1.0.7"
}
```
**Description**: `tailwindcss`, `@tailwindcss/postcss`, `postcss`, and `tailwindcss-animate` are CSS pre-processors that operate entirely at compile time. They produce no runtime output included in the JavaScript bundle. They should be in `devDependencies`. The `package.json` file contains an inline comment acknowledging this (`"//": "D3-03 NOTE: @tailwindcss/postcss..."`) noting that moving them could break builds if `npm ci --omit=dev` is ever used.
**Risk**: The comment correctly identifies the issue. These packages inflate the production `node_modules` and `npm audit --omit=dev` scope. If CI ever adds `--omit=dev` (a common hardening step), the Next.js build will fail.
**Recommendation**: Confirm that the CI and Docker build pipeline always installs all deps (not `--omit=dev`), and document this constraint. Long-term, restructure the Next.js build to use `npm ci` in a multi-stage Docker build where the build stage installs all deps but the runtime image only includes the built output.

---

### [MEDIUM] SUPPLY-CHAIN: Undeclared Runtime Dependencies (cv2, PIL, sentence-transformers)

**File**: `pyproject.toml:17-54`, `src/evidence/parsers/video_parser.py:105`, `src/evidence/parsers/image_parser.py:94-95`, `src/rag/embeddings.py:58`
**Agent**: D3 (Dependency Auditor)
**Evidence**:
```python
# src/evidence/parsers/video_parser.py:105
import cv2  # opencv-python not declared in any pyproject.toml extra

# src/evidence/parsers/image_parser.py:94-95
import pytesseract
from PIL import Image  # Pillow not declared anywhere

# src/rag/embeddings.py:58
from sentence_transformers import SentenceTransformer  # in mypy overrides but no extra
```
**Description**: Three packages are imported in source code but not declared in `pyproject.toml` at all — not even as optional extras: `opencv-python` (imported as `cv2`), `Pillow` (imported as `PIL`), and `sentence-transformers`. All three use try/except ImportError fallbacks, so runtime will not crash, but there is no way to install these correctly from the project's dependency manifest. They are listed in mypy `ignore_missing_imports` overrides, which conceals the problem from static analysis.
**Risk**: Medium. A developer or CI environment that follows only `pyproject.toml` to install dependencies will get silently degraded functionality (random embeddings, no image OCR, no video frame extraction) without any installation warning. This is especially significant for `sentence-transformers`, which is the primary embedding engine for RAG retrieval.
**Recommendation**: Add `opencv-python`, `pillow`, and `sentence-transformers` as optional extras in `pyproject.toml`, e.g., `[project.optional-dependencies]` under a `vision` or `ml` group. Update deployment documentation to specify which extras are required for full functionality.

---

### [MEDIUM] LICENSE-COMPLIANCE: bpmn-js Watermark Removal Constraint

**File**: `frontend/node_modules/bpmn-js/LICENSE`, `frontend/src/components/BPMNViewer.tsx:67-73`
**Agent**: D3 (Dependency Auditor)
**Evidence**:
```
# bpmn-js LICENSE (Camunda Services GmbH):
The source code responsible for displaying the bpmn.io project watermark that
links back to https://bpmn.io as part of rendered diagrams MUST NOT be
removed or changed. When this software is being used in a website or application,
the watermark must stay fully visible and not visually overlapped by other elements.
```
```typescript
// BPMNViewer.tsx:67-73 — no explicit watermark preservation code
const viewer = new BpmnJS({
  container: containerRef.current,
});
viewerRef.current = viewer;
await viewer.importXML(bpmnXml);
const canvas = viewer.get("canvas") as any;
canvas.zoom("fit-viewport");
```
**Description**: The `bpmn-js` package (v18.12.0, Camunda Services GmbH) carries a modified MIT license with a mandatory watermark clause. The watermark linking to `https://bpmn.io` must remain fully visible and must not be visually overlapped. `BPMNViewer.tsx` mounts the viewer directly into a container div and adds overlay elements (confidence badges, evidence count badges) on top of diagram elements. There is no audit trail confirming the bpmn.io watermark remains unobstructed in all overlay states.
**Risk**: Medium. A license violation could result in Camunda requiring removal of bpmn-js from the product or demanding a commercial license. Since KMFlow is declared Proprietary (`pyproject.toml:10`), this is a compliance exposure.
**Recommendation**: Add a visual QA step to confirm the bpmn.io watermark is visible when confidence and evidence overlays are active. Document this in the component's JSDoc. Review whether the commercial Camunda Platform license would be more appropriate given KMFlow's commercial nature.

---

### [MEDIUM] DEPENDENCY-CONSISTENCY: cryptography Declared with Narrow Upper Bound

**File**: `pyproject.toml:52`, `requirements.lock:30`
**Agent**: D3 (Dependency Auditor)
**Evidence**:
```toml
# pyproject.toml:52
"cryptography>=42.0.0,<44.0",

# requirements.lock:30 — locked to a version within the allowed range
cryptography==43.0.3
    # via
    #   kmflow (pyproject.toml)
    #   pdfminer-six
    #   pyjwt
```
**Description**: The `cryptography` package is pinned to `<44.0` in `pyproject.toml`. As of the audit date (2026-02-26), `cryptography 45.x` has been released (confirmed via the system pip which shows `45.0.7`). The upper bound `<44.0` prevents receiving security patches from the `44.x` and `45.x` series. The `cryptography` package has had multiple CVE fixes in recent major versions. Additionally, `requirements.lock` resolves to `43.0.3`, which is several point releases behind the latest `43.x`.
**Risk**: Medium. Security patches in `cryptography>=44` are blocked by the upper bound. Any CVEs fixed in 44.x or 45.x that apply to 43.x will remain unaddressed until the bound is updated.
**Recommendation**: Update `pyproject.toml:52` to `"cryptography>=42.0.0,<46.0"` (or `<47.0` to allow a wider window) and regenerate `requirements.lock`. Run the test suite against the updated version. Follow `cryptography` changelog for breaking changes when crossing major versions.

---

### [MEDIUM] UNUSED-DEPENDENCY: recharts Declared But Not Imported

**File**: `frontend/package.json:36`, `frontend/package-lock.json`
**Agent**: D3 (Dependency Auditor)
**Evidence**:
```json
// frontend/package.json:36
"recharts": "^3.7.0"
```
```
// Verified: no import of recharts found in any .tsx or .ts file under
// frontend/src/ (excluding build artifacts and node_modules)
// grep -rn 'recharts' frontend/src/ --include='*.tsx' --include='*.ts'
// → zero results
```
**Description**: `recharts` (v3.7.0) is listed as a production dependency but no TypeScript or TSX file in `frontend/src/` imports it. This was verified by searching all `.ts` and `.tsx` files in the source tree, excluding `node_modules` and `.next` build artifacts. The package is a charting library (~500KB) with its own peer dependencies (React, `d3-*`).
**Risk**: Low-medium. Adds unnecessary attack surface from an unused transitive dependency tree. Adds build time and bundle weight if Next.js accidentally tree-shakes it incorrectly. Also represents an outdated `recharts@3` package that will accumulate CVEs without being noticed since it is not functionally tested.
**Recommendation**: If recharts is planned for a future dashboard feature, document this with a comment in `package.json`. If it is not actively needed, remove it: `npm uninstall recharts` and update `package-lock.json`.

---

### [LOW] DOCKER-IMAGE: minio/mc Uses Floating Latest Tag

**File**: `docker-compose.yml:138`
**Agent**: D3 (Dependency Auditor)
**Evidence**:
```yaml
# docker-compose.yml:136-154
minio-init:
  image: minio/mc
  container_name: kmflow-minio-init
  security_opt:
    - no-new-privileges:true
```
**Description**: The `minio-init` service uses `image: minio/mc` with no version tag. Docker resolves untagged image references to `:latest`, which is pulled fresh on each `docker compose pull`. All other services in `docker-compose.yml` use pinned version tags: `pgvector/pgvector:0.8.0-pg15`, `neo4j:5.25-community`, `redis:7.4-alpine`, `minio/minio:RELEASE.2025-01-20T14-49-07Z`. The `minio/mc` client image is the only exception.
**Risk**: Low. The `minio-init` service only runs once at startup to create the bucket and then exits (`restart: "no"`). However, pulling an unpinned `minio/mc:latest` could introduce behavioral regressions if the CLI syntax changes, or pull a compromised image if the tag is hijacked.
**Recommendation**: Pin `minio/mc` to a specific release tag. Check the MinIO GitHub releases for the appropriate `mc` version that matches `minio/minio:RELEASE.2025-01-20T14-49-07Z`.

---

### [LOW] DOCKER-IMAGE: Backend and Frontend Base Images Use Floating Minor Tags

**File**: `Dockerfile.backend:1,20` and `frontend/Dockerfile:1`
**Agent**: D3 (Dependency Auditor)
**Evidence**:
```dockerfile
# Dockerfile.backend:1 and :20
FROM python:3.12-slim AS builder
FROM python:3.12-slim AS runtime

# frontend/Dockerfile:1
FROM node:20-alpine AS base
```
**Description**: The Python and Node.js base images use floating tags (`3.12-slim`, `20-alpine`) rather than digest-pinned or patch-level tags (e.g., `python:3.12.9-slim`, `node:20.18.3-alpine`). The floating tag `3.12-slim` will resolve to the latest patch release of CPython 3.12, which changes with each rebuild. This is common practice but means the base OS layer (and the packages within it) can change between builds without a code change.
**Risk**: Low for development. For a security-sensitive production deployment, a patch update to `python:3.12-slim` could introduce or remove system packages that affect behavior. The more significant risk is that `libpq-dev` and `libpq5` are installed via `apt-get` at build time without version pinning.
**Recommendation**: For production deployments, use digest-pinned base images (e.g., `FROM python:3.12-slim@sha256:<digest>`) or move to explicit patch tags. At minimum, document the accepted base image version in the Dockerfile as a comment.

---

### [LOW] SUPPLY-CHAIN: No Hash Verification for Python Package Installation

**File**: `requirements.lock:1-163` and `Dockerfile.backend:17`
**Agent**: D3 (Dependency Auditor)
**Evidence**:
```
# requirements.lock — no sha256 hashes present
# Generated by uv pip compile, but without --generate-hashes flag
fastapi==0.115.0
    # via kmflow (pyproject.toml)
cryptography==43.0.3
    # via kmflow (pyproject.toml)
```
```dockerfile
# Dockerfile.backend:17 — no hash verification
RUN pip install --no-cache-dir --prefix=/install "."
```
**Description**: The `requirements.lock` file does not contain SHA-256 hashes for packages (pip's `--require-hashes` format). The npm `package-lock.json` correctly contains SHA-512 integrity hashes for all 613 packages, providing tamper detection at install time. The Python side has no equivalent. The `uv pip compile` command supports `--generate-hashes` to produce a hashed requirements file.
**Risk**: Low-medium. Without hash verification, a man-in-the-middle attack or a compromised PyPI mirror could serve a different package version or a tampered package file without detection during `pip install`.
**Recommendation**: Regenerate `requirements.lock` with `uv pip compile pyproject.toml -o requirements.lock --generate-hashes` and update the Dockerfile to use `pip install --no-cache-dir --require-hashes -r requirements.lock`.

---

### [LOW] DEPENDENCY-QUALITY: minimatch Override Indicates Unresolved Transitive CVE

**File**: `frontend/package.json:41-43`
**Agent**: D3 (Dependency Auditor)
**Evidence**:
```json
"overrides": {
  "minimatch": "^10.2.1"
}
```
**Description**: The `overrides` block forces `minimatch` to `^10.2.1`, which is the remediation for CVE-2022-3517 (ReDoS in minimatch `<3.0.5`). While `npm audit` currently reports 0 vulnerabilities (confirming the override is effective), the fact that the override is still needed means one or more transitive dependencies still declare a dependency on an old `minimatch` range. If this override is accidentally removed, the vulnerability reactivates.
**Risk**: Low. The override is working. The risk is maintenance: if the package.json overrides are removed (e.g., during a `npm upgrade` operation), CVE-2022-3517 would return.
**Recommendation**: Add a comment documenting the CVE number and the package(s) requiring the old minimatch version. Periodically check whether those transitive dependencies have been updated, at which point the override can be safely removed.

---

## Python Dependency Health Summary

| Package | Lock Version | Pyproject Range | Usage Verified | Status |
|---|---|---|---|---|
| fastapi | 0.129.0 | >=0.115.0,<1.0 | Yes | SAFE |
| uvicorn[standard] | 0.41.0 | >=0.32.0,<1.0 | Yes | SAFE |
| sqlalchemy[asyncio] | 2.0.46 | >=2.0.36,<3.0 | Yes | SAFE |
| asyncpg | 0.31.0 | >=0.30.0,<1.0 | Yes | SAFE |
| alembic | 1.18.4 | >=1.14.0,<2.0 | Yes | SAFE |
| pgvector | 0.4.2 | >=0.3.6,<1.0 | Yes | SAFE |
| neo4j | 5.28.3 | >=5.27.0,<6.0 | Yes | SAFE |
| redis[hiredis] | 5.3.1 | >=5.2.0,<6.0 | Yes | SAFE |
| pydantic | 2.12.5 | >=2.10.0,<3.0 | Yes | SAFE |
| pydantic-settings | 2.13.1 | >=2.7.0,<3.0 | Yes | SAFE |
| pyyaml | 6.0.3 | >=6.0,<7.0 | Yes | SAFE |
| python-dotenv | 1.2.1 | >=1.0.1,<2.0 | Yes | SAFE |
| httpx | 0.28.1 | >=0.28.0,<1.0 | Yes | SAFE |
| python-multipart | 0.0.22 | >=0.0.22,<1.0 | Yes | SAFE |
| aiofiles | 24.1.0 | >=24.1.0 | Yes | LOW (no upper bound) |
| slowapi | 0.1.9 | >=0.1.9,<1.0 | Yes | SAFE |
| python-magic | 0.4.27 | >=0.4.27,<1.0 | Yes (lazy import) | SAFE |
| python-docx | 1.2.0 | >=1.1.0,<2.0 | Yes (lazy import) | SAFE |
| pdfplumber | 0.11.9 | >=0.11.0,<1.0 | Yes | SAFE |
| openpyxl | 3.1.5 | >=3.1.0,<4.0 | Yes | SAFE |
| lxml | 5.4.0 | >=5.0.0,<6.0 | Yes | SAFE |
| defusedxml | 0.7.1 | >=0.7.0,<1.0 | Yes | SAFE |
| numpy | 2.4.2 | >=1.26.0,<3.0 | Yes | SAFE |
| PyJWT[crypto] | 2.11.0 | >=2.9.0,<3.0 | Yes | SAFE |
| bcrypt | 4.3.0 | >=4.0.0,<5.0 | Yes | SAFE |
| cryptography | 43.0.3 | >=42.0.0,<44.0 | Yes (direct + transitive) | MEDIUM (upper bound blocks 44+/45+) |
| email-validator | 2.3.0 | >=2.0.0,<3.0 | Yes | SAFE |
| pillow | 12.1.1 | NOT DECLARED | Yes (lazy import in image_parser.py) | MEDIUM (undeclared) |
| opencv-python (cv2) | NOT LOCKED | NOT DECLARED | Yes (lazy import in video_parser.py) | MEDIUM (undeclared) |
| sentence-transformers | NOT LOCKED | NOT DECLARED | Yes (lazy import in embeddings.py) | MEDIUM (undeclared) |

### Optional Extras (Declared but Undocumented Install Instructions)
| Extra | Package | Runtime Usage | Notes |
|---|---|---|---|
| [ml] | scikit-learn | Not found in current imports | Declared future use |
| [pdf] | weasyprint | Used in pdf_generator.py (lazy) | Correctly declared |
| [datalake] | deltalake, pyarrow | Not found in current imports | Declared future use |
| [ai] | anthropic>=0.40.0 | Used in rag/copilot.py | Correctly declared |
| [databricks] | databricks-sdk | Not found in current imports | Declared future use |

---

## Docker Image Pinning Summary

| Service | Image | Pinned | Notes |
|---|---|---|---|
| postgres | pgvector/pgvector:0.8.0-pg15 | Yes | Specific version |
| neo4j | neo4j:5.25-community | Yes | Specific version |
| redis | redis:7.4-alpine | Yes | Minor+patch pinned |
| cib7 | cibseven/cibseven:run-2.1.0 | Yes | Specific version |
| minio | minio/minio:RELEASE.2025-01-20T14-49-07Z | Yes | Timestamped release |
| minio-init | minio/mc | NO | Floating :latest |
| mailpit | axllent/mailpit:v1.22 | Yes | Specific version |
| backend | python:3.12-slim | Partial | Floating patch level |
| frontend | node:20-alpine | Partial | Floating patch level |

---

## Supply Chain Risk Score: MEDIUM

No active CVEs detected in the dependency graph. The `package-lock.json` provides strong integrity guarantees for the JavaScript supply chain (613 SHA-512 hashes). The Python side has weaker guarantees: `requirements.lock` exists but is not enforced by the Docker build and lacks hash verification. The three undeclared optional dependencies (cv2, PIL, sentence-transformers) represent undocumented supply chain surface area. The bpmn-js license constraint requires ongoing visual verification compliance.
