# KMFlow Knowledge Graph Ontology
# ================================
# Formal schema for the Neo4j knowledge graph. All node types, relationship
# types, and constraints are defined here. Code loads this at startup via
# the ontology loader â€” no hardcoded constants elsewhere.
#
# Version history:
#   1.0.0 - Initial formalization from code constants (Phase A)

version: "2.0.0"
description: >
  KMFlow process intelligence knowledge graph ontology. Captures activities,
  decisions, roles, systems, evidence, documents, processes, policies,
  controls, regulations, TOM definitions, and gaps identified during
  consulting engagements. Reconciled with PRD v2.1 Section 6.2.

# ---------------------------------------------------------------------------
# Node Types
# ---------------------------------------------------------------------------
node_types:
  Activity:
    description: A business process step or task performed by a role.
    extractable: true
    entity_type: activity
    required_properties:
      - name
      - engagement_id
    optional_properties:
      - confidence
      - aliases
      - entity_type

  Decision:
    description: A conditional branch point in a business process.
    extractable: true
    entity_type: decision
    required_properties:
      - name
      - engagement_id
    optional_properties:
      - confidence
      - aliases
      - entity_type

  Role:
    description: An organizational role or team that performs activities.
    extractable: true
    entity_type: role
    required_properties:
      - name
      - engagement_id
    optional_properties:
      - confidence
      - aliases
      - entity_type

  System:
    description: An IT system, application, or platform used in processes.
    extractable: true
    entity_type: system
    required_properties:
      - name
      - engagement_id
    optional_properties:
      - confidence
      - aliases
      - entity_type

  Evidence:
    description: A piece of evidence ingested from a client source.
    extractable: false
    required_properties:
      - name
      - engagement_id
      - evidence_item_id

  Document:
    description: A named document referenced in evidence text.
    extractable: true
    entity_type: document
    required_properties:
      - name
      - engagement_id
    optional_properties:
      - confidence
      - aliases
      - entity_type

  Process:
    description: A named end-to-end business process.
    extractable: false
    required_properties:
      - name
      - engagement_id

  Subprocess:
    description: A sub-process within a larger process.
    extractable: false
    required_properties:
      - name
      - engagement_id

  Policy:
    description: An organizational or regulatory policy governing a process.
    extractable: false
    required_properties:
      - name
      - engagement_id

  Control:
    description: A control mechanism that enforces policy compliance.
    extractable: false
    required_properties:
      - name
      - engagement_id

  Regulation:
    description: An external regulatory framework or requirement.
    extractable: false
    required_properties:
      - name
      - engagement_id

  TOM:
    description: A Target Operating Model dimension or component.
    extractable: false
    required_properties:
      - name
      - engagement_id

  Gap:
    description: An identified gap between current state and target state.
    extractable: false
    required_properties:
      - name
      - engagement_id

  Application:
    description: A desktop or web application observed during task mining.
    extractable: false
    required_properties:
      - name
      - engagement_id
    optional_properties:
      - app_category
      - platform

  DataObject:
    description: An input or output data artifact consumed or produced by activities.
    extractable: true
    entity_type: data_object
    required_properties:
      - name
      - engagement_id
    optional_properties:
      - confidence
      - aliases

  Assertion:
    description: A knowledge claim about the process, linked to evidence and epistemic frames.
    extractable: false
    required_properties:
      - name
      - engagement_id
    optional_properties:
      - frame_kind
      - authority_scope
      - access_policy

  Event:
    description: A BPMN event (start, intermediate, end) in a process flow.
    extractable: true
    entity_type: event
    required_properties:
      - name
      - engagement_id
    optional_properties:
      - event_type
      - confidence

  Gateway:
    description: A BPMN gateway (exclusive, parallel, inclusive) controlling process flow.
    extractable: true
    entity_type: gateway
    required_properties:
      - name
      - engagement_id
    optional_properties:
      - gateway_type
      - confidence

  SurveyClaim:
    description: A claim from a knowledge survey or interview, pending validation.
    extractable: false
    required_properties:
      - name
      - engagement_id
    optional_properties:
      - survey_id
      - respondent_role

  BusinessRule:
    description: >
      A business rule governing an activity (e.g., approval threshold, SLA).
      Extracted from policy documents, system configs, or interviews.
      Used by RuleConflictDetector to find contradictory rules across sources.
    extractable: false
    required_properties:
      - rule_text
      - engagement_id
      - source_id
    optional_properties:
      - threshold_value
      - threshold_currency
      - effective_from
      - effective_to
      - source_weight

  ControlRequirement:
    description: >
      A governance control requirement extracted from regulatory policy.
      Maps activity types to required control types. Used by ControlGapDetector
      to identify activities missing required GOVERNED_BY edges.
    extractable: false
    required_properties:
      - name
      - engagement_id
      - activity_pattern
      - required_control_type
    optional_properties:
      - source_id
      - criticality
      - source_weight

  UserAction:
    description: An aggregated user action observed via desktop task mining.
    extractable: false
    required_properties:
      - name
      - engagement_id
      - action_category
    optional_properties:
      - duration_seconds
      - event_count

  SwitchingTrace:
    description: A sequence of application switches observed during task mining, used for friction analysis.
    extractable: false
    required_properties:
      - name
      - engagement_id
    optional_properties:
      - friction_score
      - is_ping_pong
      - total_duration_ms
      - app_count

  VisualContextEvent:
    description: A visual context event captured from the desktop agent for screen state classification.
    extractable: false
    required_properties:
      - name
      - engagement_id
    optional_properties:
      - screen_state_class
      - confidence
      - trigger_reason
      - dwell_ms

  ScreenState:
    description: A screen state classification category (queue, search, data_entry, review, error, etc.).
    extractable: false
    required_properties:
      - name
      - engagement_id
      - screen_state_class

  Session:
    description: >
      A task mining capture session stub. One node per unique session_id,
      created during VCE graph ingestion to anchor CAPTURED_IN edges.
    extractable: false
    required_properties:
      - name
      - engagement_id
      - session_id

  CaseLink:
    description: A correlation link between an endpoint event and a business case.
    extractable: false
    required_properties:
      - name
      - engagement_id
    optional_properties:
      - method
      - confidence

# ---------------------------------------------------------------------------
# Relationship Types
# ---------------------------------------------------------------------------
relationship_types:
  SUPPORTED_BY:
    description: Entity is supported by evidence. Primary evidence-linking edge.
    valid_from:
      - Activity
      - Decision
      - Role
      - System
      - Document
      - Process
      - Subprocess
    valid_to:
      - Evidence

  GOVERNED_BY:
    description: Process or activity is governed by a policy or regulation.
    valid_from:
      - Process
      - Activity
      - Subprocess
    valid_to:
      - Policy
      - Regulation

  REQUIRES_CONTROL:
    description: A ControlRequirement specifies that matching activities must have governance controls.
    valid_from:
      - ControlRequirement
    valid_to:
      - Activity

  DEVIATES_FROM:
    description: Observed process deviates from documented/expected process.
    valid_from:
      - Activity
      - Process
      - UserAction
    valid_to:
      - Process
      - Policy
      - TOM
      - Activity

  IMPLEMENTS:
    description: Activity or control implements a policy or regulation.
    valid_from:
      - Activity
      - Control
      - Process
    valid_to:
      - Policy
      - Regulation
      - TOM

  CONTRADICTS:
    description: Two pieces of evidence or elements contradict each other. Bidirectional.
    valid_from:
      - Evidence
      - Activity
      - Document
      - Assertion
      - SurveyClaim
    valid_to:
      - Evidence
      - Activity
      - Document
      - Assertion
      - SurveyClaim
    constraints:
      bidirectional: true

  MITIGATES:
    description: A control mitigates a gap or risk.
    valid_from:
      - Control
      - Activity
    valid_to:
      - Gap
      - Decision

  REQUIRES:
    description: A decision or activity requires another activity or input.
    valid_from:
      - Decision
      - Activity
      - Process
    valid_to:
      - Activity
      - Document
      - System

  FOLLOWED_BY:
    description: Temporal sequence between activities in a process flow.
    valid_from:
      - Activity
    valid_to:
      - Activity
      - Decision
    optional_properties:
      - duration_ms
      - gap_ms

  OWNED_BY:
    description: An activity or process is owned/performed by a role.
    valid_from:
      - Activity
      - Process
      - Subprocess
    valid_to:
      - Role

  USES:
    description: An activity or process uses a system or document.
    valid_from:
      - Activity
      - Process
      - Role
    valid_to:
      - System
      - Document

  CO_OCCURS_WITH:
    description: >
      Two entities co-occur in the same evidence fragment. Inferred during
      graph construction, not manually assigned.
    valid_from:
      - Activity
      - Decision
      - Role
      - System
      - Document
    valid_to:
      - Activity
      - Decision
      - Role
      - System
      - Document

  SIMILAR_TO:
    description: >
      Two entities are semantically similar based on embedding distance.
      Inferred during semantic analysis.
    valid_from:
      - Activity
      - Process
      - Document
    valid_to:
      - Activity
      - Process
      - Document

  PERFORMED_IN:
    description: A user action was performed in a specific application.
    valid_from:
      - UserAction
    valid_to:
      - Application

  PRECEDED_BY:
    description: >
      Temporal ordering between user actions observed via task mining.
      UserAction A PRECEDED_BY UserAction B means B happened before A.
    valid_from:
      - UserAction
    valid_to:
      - UserAction

  SUPPORTS:
    description: >
      Observed task mining behavior supports a documented activity.
      Created by the semantic bridge when UserAction descriptions match
      Activity names above the similarity threshold.
    valid_from:
      - UserAction
    valid_to:
      - Activity

  MAPS_TO:
    description: >
      A desktop application maps to a known system in the TOM/architecture.
      Created by the semantic bridge when Application names match System nodes.
    valid_from:
      - Application
    valid_to:
      - System

  HAS_RULE:
    description: >
      An activity has an associated business rule. Used by
      RuleConflictDetector to find contradictory rules from different sources.
    valid_from:
      - Activity
    valid_to:
      - BusinessRule

  # -------------------------------------------------------------------------
  # PRD v2.1 Controlled Edge Vocabulary (12 types, Section 6.2)
  # -------------------------------------------------------------------------
  PRECEDES:
    description: Activity A happens before Activity B. Acyclic within variant.
    valid_from:
      - Activity
    valid_to:
      - Activity
    constraints:
      acyclic_within: variant_id
    optional_properties:
      - variant_id
      - frequency

  TRIGGERS:
    description: Event or gateway causes an Activity to start.
    valid_from:
      - Event
      - Gateway
    valid_to:
      - Activity

  DEPENDS_ON:
    description: Activity A requires Activity B to complete first. Acyclic.
    valid_from:
      - Activity
    valid_to:
      - Activity
    constraints:
      acyclic_within: variant_id

  CONSUMES:
    description: Activity uses a DataObject as input.
    valid_from:
      - Activity
    valid_to:
      - DataObject

  PRODUCES:
    description: Activity generates a DataObject as output.
    valid_from:
      - Activity
    valid_to:
      - DataObject

  PERFORMED_BY:
    description: Activity is performed by a Role.
    valid_from:
      - Activity
    valid_to:
      - Role
    optional_properties:
      - confidence

  EVIDENCED_BY:
    description: Assertion is supported by an Evidence item.
    valid_from:
      - Assertion
      - Activity
      - Process
    valid_to:
      - Evidence

  SUPERSEDES:
    description: Assertion X replaces Assertion Y. Requires bitemporal validity.
    valid_from:
      - Assertion
    valid_to:
      - Assertion
    optional_properties:
      - valid_from_time
      - retracted_at

  DECOMPOSES_INTO:
    description: Process breaks down into Subprocess. Hierarchical.
    valid_from:
      - Process
    valid_to:
      - Subprocess
      - Activity

  VARIANT_OF:
    description: Activity A is an alternative to Activity B. Bidirectional.
    valid_from:
      - Activity
    valid_to:
      - Activity
    constraints:
      bidirectional: true

  MERGED_EDGE:
    description: Edge transferred from a non-canonical node during naming variant merge. Preserves original relationship properties.
    valid_from:
      - Activity
    valid_to:
      - Activity
      - Role
      - Evidence
      - Decision
      - System
      - BusinessRule
    optional_properties:
      - merged_from

  # -------------------------------------------------------------------------
  # WGI Alignment: Switching, VCE, Correlation, and Graph Enhancement Edges
  # -------------------------------------------------------------------------
  OBSERVED_IN:
    description: A switching trace or VCE was observed in a specific session.
    valid_from:
      - SwitchingTrace
      - VisualContextEvent
    valid_to:
      - Application

  INVOLVES:
    description: A switching trace involves a specific application.
    valid_from:
      - SwitchingTrace
    valid_to:
      - Application

  INDICATES_FRICTION:
    description: A switching trace indicates friction between two applications (rapid switching, ping-pong).
    valid_from:
      - SwitchingTrace
    valid_to:
      - Application

  CLASSIFIED_AS:
    description: A VCE is classified as a specific screen state.
    valid_from:
      - VisualContextEvent
    valid_to:
      - ScreenState

  OBSERVED_DURING:
    description: A VCE was observed during use of a specific application.
    valid_from:
      - VisualContextEvent
    valid_to:
      - Application

  CAPTURED_IN:
    description: A VCE was captured within a specific task mining session.
    valid_from:
      - VisualContextEvent
    valid_to:
      - Session

  CASE_HAS_EVENT:
    description: A business case contains a canonical activity event, linked by the correlation engine.
    valid_from:
      - Process
    valid_to:
      - Activity
    optional_properties:
      - link_method
      - link_confidence

  EVENT_MAPS_TO_ACTIVITY:
    description: A canonical event maps to a documented process activity.
    valid_from:
      - UserAction
    valid_to:
      - Activity
    optional_properties:
      - confidence
      - mapping_source

# ---------------------------------------------------------------------------
# Evidence Categories (mirrors EvidenceCategory enum for reference)
# ---------------------------------------------------------------------------
evidence_categories:
  - documents
  - images
  - audio
  - video
  - structured_data
  - saas_exports
  - km4work
  - bpm_process_models
  - regulatory_policy
  - controls_evidence
  - domain_communications
  - job_aids_edge_cases
