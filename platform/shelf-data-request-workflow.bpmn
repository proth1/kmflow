<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
  xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  id="Definitions_ShelfDataRequest"
  targetNamespace="http://bpmn.io/schema/bpmn"
  exporter="KMFlow Platform"
  exporterVersion="1.0.0">

  <bpmn:collaboration id="Collaboration_ShelfDataRequest">
    <bpmn:participant id="Participant_Pool" name="KMFlow Shelf Data Request" processRef="Process_ShelfDataRequest"/>
  </bpmn:collaboration>

  <bpmn:process id="Process_ShelfDataRequest" name="Shelf Data Request Management" isExecutable="true">

    <bpmn:laneSet id="LaneSet_1">
      <bpmn:lane id="Lane_EngagementLead" name="Engagement Lead">
        <bpmn:flowNodeRef>StartEvent_1</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_DefineRequirements</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_RequestEngine" name="Request Engine">
        <bpmn:flowNodeRef>Task_GenerateRequest</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_DeliverRequest</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_ClassifyReceived</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Gateway_Fulfillment</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_MarkComplete</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_IdentifyGaps</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>EndEvent_Fulfilled</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_Client" name="Client">
        <bpmn:flowNodeRef>Gateway_AwaitResponse</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Event_EvidenceReceived</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Event_Timeout</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_SendReminder</bpmn:flowNodeRef>
      </bpmn:lane>
    </bpmn:laneSet>

    <!-- Start Event -->
    <bpmn:startEvent id="StartEvent_1" name="Request&#10;Initiated">
      <bpmn:outgoing>Flow_1</bpmn:outgoing>
    </bpmn:startEvent>

    <!-- User Task: Define Data Requirements -->
    <bpmn:userTask id="Task_DefineRequirements" name="Define Data Requirements" camunda:candidateGroups="engagement-leads">
      <bpmn:incoming>Flow_1</bpmn:incoming>
      <bpmn:outgoing>Flow_2</bpmn:outgoing>
    </bpmn:userTask>

    <!-- Service Task: Generate Request Document -->
    <bpmn:serviceTask id="Task_GenerateRequest" name="Generate Request Document" camunda:type="external" camunda:topic="kmflow.evidence.classify">
      <bpmn:incoming>Flow_2</bpmn:incoming>
      <bpmn:outgoing>Flow_3</bpmn:outgoing>
    </bpmn:serviceTask>

    <!-- Send Task: Deliver Request to Client -->
    <bpmn:sendTask id="Task_DeliverRequest" name="Deliver Request to Client">
      <bpmn:incoming>Flow_3</bpmn:incoming>
      <bpmn:incoming>Flow_GapLoop</bpmn:incoming>
      <bpmn:outgoing>Flow_4</bpmn:outgoing>
    </bpmn:sendTask>

    <!-- Event-Based Gateway: Await Response -->
    <bpmn:eventBasedGateway id="Gateway_AwaitResponse" name="Await&#10;Response">
      <bpmn:incoming>Flow_4</bpmn:incoming>
      <bpmn:incoming>Flow_ReminderLoop</bpmn:incoming>
      <bpmn:outgoing>Flow_EvidenceReceived</bpmn:outgoing>
      <bpmn:outgoing>Flow_Timeout</bpmn:outgoing>
    </bpmn:eventBasedGateway>

    <!-- Message Intermediate Catch Event: Evidence Received -->
    <bpmn:intermediateCatchEvent id="Event_EvidenceReceived" name="Evidence&#10;Received">
      <bpmn:incoming>Flow_EvidenceReceived</bpmn:incoming>
      <bpmn:outgoing>Flow_6</bpmn:outgoing>
      <bpmn:messageEventDefinition messageRef="Message_EvidenceReceived"/>
    </bpmn:intermediateCatchEvent>

    <!-- Timer Intermediate Catch Event: 7-Day Timeout -->
    <bpmn:intermediateCatchEvent id="Event_Timeout" name="7-Day&#10;Timeout">
      <bpmn:incoming>Flow_Timeout</bpmn:incoming>
      <bpmn:outgoing>Flow_7</bpmn:outgoing>
      <bpmn:timerEventDefinition>
        <bpmn:timeDuration xsi:type="bpmn:tFormalExpression">P7D</bpmn:timeDuration>
      </bpmn:timerEventDefinition>
    </bpmn:intermediateCatchEvent>

    <!-- Send Task: Send Follow-Up Reminder -->
    <bpmn:sendTask id="Task_SendReminder" name="Send Follow-Up Reminder">
      <bpmn:incoming>Flow_7</bpmn:incoming>
      <bpmn:outgoing>Flow_ReminderLoop</bpmn:outgoing>
    </bpmn:sendTask>

    <!-- Service Task: Classify Received Evidence -->
    <bpmn:serviceTask id="Task_ClassifyReceived" name="Classify Received Evidence" camunda:type="external" camunda:topic="kmflow.evidence.classify">
      <bpmn:incoming>Flow_6</bpmn:incoming>
      <bpmn:outgoing>Flow_8</bpmn:outgoing>
    </bpmn:serviceTask>

    <!-- XOR Gateway: Fulfillment Check -->
    <bpmn:exclusiveGateway id="Gateway_Fulfillment" name="Fulfillment&#10;Check?">
      <bpmn:incoming>Flow_8</bpmn:incoming>
      <bpmn:outgoing>Flow_Complete</bpmn:outgoing>
      <bpmn:outgoing>Flow_IdentifyGaps</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <!-- Service Task: Mark Request Complete -->
    <bpmn:serviceTask id="Task_MarkComplete" name="Mark Request Complete" camunda:type="external" camunda:topic="kmflow.request.complete">
      <bpmn:incoming>Flow_Complete</bpmn:incoming>
      <bpmn:outgoing>Flow_10</bpmn:outgoing>
    </bpmn:serviceTask>

    <!-- Service Task: Identify Gaps -->
    <bpmn:serviceTask id="Task_IdentifyGaps" name="Identify Gaps" camunda:type="external" camunda:topic="kmflow.request.gaps">
      <bpmn:incoming>Flow_IdentifyGaps</bpmn:incoming>
      <bpmn:outgoing>Flow_GapLoop</bpmn:outgoing>
    </bpmn:serviceTask>

    <!-- End Event: Request Fulfilled -->
    <bpmn:endEvent id="EndEvent_Fulfilled" name="Request&#10;Fulfilled">
      <bpmn:incoming>Flow_10</bpmn:incoming>
    </bpmn:endEvent>

    <!-- Sequence Flows -->
    <bpmn:sequenceFlow id="Flow_1" sourceRef="StartEvent_1" targetRef="Task_DefineRequirements"/>
    <bpmn:sequenceFlow id="Flow_2" sourceRef="Task_DefineRequirements" targetRef="Task_GenerateRequest"/>
    <bpmn:sequenceFlow id="Flow_3" sourceRef="Task_GenerateRequest" targetRef="Task_DeliverRequest"/>
    <bpmn:sequenceFlow id="Flow_4" sourceRef="Task_DeliverRequest" targetRef="Gateway_AwaitResponse"/>
    <bpmn:sequenceFlow id="Flow_EvidenceReceived" sourceRef="Gateway_AwaitResponse" targetRef="Event_EvidenceReceived"/>
    <bpmn:sequenceFlow id="Flow_Timeout" sourceRef="Gateway_AwaitResponse" targetRef="Event_Timeout"/>
    <bpmn:sequenceFlow id="Flow_6" sourceRef="Event_EvidenceReceived" targetRef="Task_ClassifyReceived"/>
    <bpmn:sequenceFlow id="Flow_7" sourceRef="Event_Timeout" targetRef="Task_SendReminder"/>
    <bpmn:sequenceFlow id="Flow_ReminderLoop" sourceRef="Task_SendReminder" targetRef="Gateway_AwaitResponse"/>
    <bpmn:sequenceFlow id="Flow_8" sourceRef="Task_ClassifyReceived" targetRef="Gateway_Fulfillment"/>
    <bpmn:sequenceFlow id="Flow_Complete" name="&#8805; 80%" sourceRef="Gateway_Fulfillment" targetRef="Task_MarkComplete">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${fulfillment &gt;= 80}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_IdentifyGaps" name="&lt; 80%" sourceRef="Gateway_Fulfillment" targetRef="Task_IdentifyGaps">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${fulfillment &lt; 80}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_GapLoop" sourceRef="Task_IdentifyGaps" targetRef="Task_DeliverRequest"/>
    <bpmn:sequenceFlow id="Flow_10" sourceRef="Task_MarkComplete" targetRef="EndEvent_Fulfilled"/>

  </bpmn:process>

  <bpmn:message id="Message_EvidenceReceived" name="EvidenceReceived"/>

  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Collaboration_ShelfDataRequest">

      <!-- Pool: 1500x700 -->
      <bpmndi:BPMNShape id="Participant_Pool_di" bpmnElement="Participant_Pool" isHorizontal="true">
        <dc:Bounds x="155" y="47" width="1500" height="700"/>
      </bpmndi:BPMNShape>

      <!-- Lane: Engagement Lead (top, height=190) -->
      <bpmndi:BPMNShape id="Lane_EngagementLead_di" bpmnElement="Lane_EngagementLead" isHorizontal="true">
        <dc:Bounds x="185" y="47" width="1470" height="190"/>
      </bpmndi:BPMNShape>

      <!-- Lane: Request Engine (middle, height=260) -->
      <bpmndi:BPMNShape id="Lane_RequestEngine_di" bpmnElement="Lane_RequestEngine" isHorizontal="true">
        <dc:Bounds x="185" y="237" width="1470" height="260"/>
      </bpmndi:BPMNShape>

      <!-- Lane: Client (bottom, height=250) -->
      <bpmndi:BPMNShape id="Lane_Client_di" bpmnElement="Lane_Client" isHorizontal="true">
        <dc:Bounds x="185" y="497" width="1470" height="250"/>
      </bpmndi:BPMNShape>

      <!-- ===== Engagement Lead Lane (y center ~142) ===== -->

      <!-- Start Event -->
      <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
        <dc:Bounds x="247" y="124" width="36" height="36"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds x="237" y="167" width="55" height="27"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Define Data Requirements -->
      <bpmndi:BPMNShape id="Task_DefineRequirements_di" bpmnElement="Task_DefineRequirements">
        <dc:Bounds x="335" y="104" width="151" height="76"/>
      </bpmndi:BPMNShape>

      <!-- ===== Request Engine Lane (y center ~367) ===== -->

      <!-- Generate Request Document -->
      <bpmndi:BPMNShape id="Task_GenerateRequest_di" bpmnElement="Task_GenerateRequest">
        <dc:Bounds x="335" y="310" width="151" height="76"/>
      </bpmndi:BPMNShape>

      <!-- Deliver Request to Client -->
      <bpmndi:BPMNShape id="Task_DeliverRequest_di" bpmnElement="Task_DeliverRequest">
        <dc:Bounds x="536" y="310" width="151" height="76"/>
      </bpmndi:BPMNShape>

      <!-- Classify Received Evidence -->
      <bpmndi:BPMNShape id="Task_ClassifyReceived_di" bpmnElement="Task_ClassifyReceived">
        <dc:Bounds x="847" y="310" width="151" height="76"/>
      </bpmndi:BPMNShape>

      <!-- Gateway: Fulfillment Check -->
      <bpmndi:BPMNShape id="Gateway_Fulfillment_di" bpmnElement="Gateway_Fulfillment" isMarkerVisible="true">
        <dc:Bounds x="1048" y="323" width="50" height="50"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1036" y="285" width="75" height="27"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Mark Request Complete -->
      <bpmndi:BPMNShape id="Task_MarkComplete_di" bpmnElement="Task_MarkComplete">
        <dc:Bounds x="1158" y="310" width="151" height="76"/>
      </bpmndi:BPMNShape>

      <!-- Identify Gaps -->
      <bpmndi:BPMNShape id="Task_IdentifyGaps_di" bpmnElement="Task_IdentifyGaps">
        <dc:Bounds x="1048" y="410" width="151" height="76"/>
      </bpmndi:BPMNShape>

      <!-- End Event: Request Fulfilled -->
      <bpmndi:BPMNShape id="EndEvent_Fulfilled_di" bpmnElement="EndEvent_Fulfilled">
        <dc:Bounds x="1359" y="330" width="36" height="36"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1349" y="373" width="55" height="27"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- ===== Client Lane (y center ~622) ===== -->

      <!-- Event-Based Gateway: Await Response -->
      <bpmndi:BPMNShape id="Gateway_AwaitResponse_di" bpmnElement="Gateway_AwaitResponse">
        <dc:Bounds x="586" y="567" width="50" height="50"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds x="584" y="624" width="55" height="27"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Message Event: Evidence Received -->
      <bpmndi:BPMNShape id="Event_EvidenceReceived_di" bpmnElement="Event_EvidenceReceived">
        <dc:Bounds x="738" y="574" width="36" height="36"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds x="728" y="617" width="55" height="27"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Timer Event: 7-Day Timeout -->
      <bpmndi:BPMNShape id="Event_Timeout_di" bpmnElement="Event_Timeout">
        <dc:Bounds x="593" y="520" width="36" height="36"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds x="535" y="531" width="48" height="27"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Send Follow-Up Reminder -->
      <bpmndi:BPMNShape id="Task_SendReminder_di" bpmnElement="Task_SendReminder">
        <dc:Bounds x="335" y="554" width="151" height="76"/>
      </bpmndi:BPMNShape>

      <!-- ===== Sequence Flow Edges ===== -->

      <!-- Flow_1: Start -> Define Requirements -->
      <bpmndi:BPMNEdge id="Flow_1_di" bpmnElement="Flow_1">
        <di:waypoint x="283" y="142"/>
        <di:waypoint x="335" y="142"/>
      </bpmndi:BPMNEdge>

      <!-- Flow_2: Define Requirements -> Generate Request (down to Request Engine) -->
      <bpmndi:BPMNEdge id="Flow_2_di" bpmnElement="Flow_2">
        <di:waypoint x="410" y="180"/>
        <di:waypoint x="410" y="310"/>
      </bpmndi:BPMNEdge>

      <!-- Flow_3: Generate -> Deliver -->
      <bpmndi:BPMNEdge id="Flow_3_di" bpmnElement="Flow_3">
        <di:waypoint x="486" y="348"/>
        <di:waypoint x="536" y="348"/>
      </bpmndi:BPMNEdge>

      <!-- Flow_4: Deliver -> Await Response (down to Client) -->
      <bpmndi:BPMNEdge id="Flow_4_di" bpmnElement="Flow_4">
        <di:waypoint x="611" y="386"/>
        <di:waypoint x="611" y="567"/>
      </bpmndi:BPMNEdge>

      <!-- Flow_EvidenceReceived: Await -> Evidence Received -->
      <bpmndi:BPMNEdge id="Flow_EvidenceReceived_di" bpmnElement="Flow_EvidenceReceived">
        <di:waypoint x="636" y="592"/>
        <di:waypoint x="738" y="592"/>
      </bpmndi:BPMNEdge>

      <!-- Flow_Timeout: Await -> Timeout (up) -->
      <bpmndi:BPMNEdge id="Flow_Timeout_di" bpmnElement="Flow_Timeout">
        <di:waypoint x="611" y="567"/>
        <di:waypoint x="611" y="556"/>
      </bpmndi:BPMNEdge>

      <!-- Flow_6: Evidence Received -> Classify (up to Request Engine) -->
      <bpmndi:BPMNEdge id="Flow_6_di" bpmnElement="Flow_6">
        <di:waypoint x="774" y="592"/>
        <di:waypoint x="922" y="592"/>
        <di:waypoint x="922" y="386"/>
      </bpmndi:BPMNEdge>

      <!-- Flow_7: Timeout -> Send Reminder (left) -->
      <bpmndi:BPMNEdge id="Flow_7_di" bpmnElement="Flow_7">
        <di:waypoint x="593" y="538"/>
        <di:waypoint x="540" y="538"/>
        <di:waypoint x="540" y="592"/>
        <di:waypoint x="486" y="592"/>
      </bpmndi:BPMNEdge>

      <!-- Flow_ReminderLoop: Send Reminder -> Await Response (loop back right) -->
      <bpmndi:BPMNEdge id="Flow_ReminderLoop_di" bpmnElement="Flow_ReminderLoop">
        <di:waypoint x="410" y="630"/>
        <di:waypoint x="410" y="700"/>
        <di:waypoint x="611" y="700"/>
        <di:waypoint x="611" y="617"/>
      </bpmndi:BPMNEdge>

      <!-- Flow_8: Classify -> Fulfillment Check -->
      <bpmndi:BPMNEdge id="Flow_8_di" bpmnElement="Flow_8">
        <di:waypoint x="998" y="348"/>
        <di:waypoint x="1048" y="348"/>
      </bpmndi:BPMNEdge>

      <!-- Flow_Complete: Fulfillment >= 80% -> Mark Complete -->
      <bpmndi:BPMNEdge id="Flow_Complete_di" bpmnElement="Flow_Complete">
        <di:waypoint x="1098" y="348"/>
        <di:waypoint x="1158" y="348"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1105" y="330" width="40" height="14"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>

      <!-- Flow_IdentifyGaps: Fulfillment < 80% -> Identify Gaps (down) -->
      <bpmndi:BPMNEdge id="Flow_IdentifyGaps_di" bpmnElement="Flow_IdentifyGaps">
        <di:waypoint x="1073" y="373"/>
        <di:waypoint x="1073" y="410"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1080" y="388" width="35" height="14"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>

      <!-- Flow_GapLoop: Identify Gaps -> Deliver Request (loop back left) -->
      <bpmndi:BPMNEdge id="Flow_GapLoop_di" bpmnElement="Flow_GapLoop">
        <di:waypoint x="1048" y="448"/>
        <di:waypoint x="611" y="448"/>
        <di:waypoint x="611" y="386"/>
      </bpmndi:BPMNEdge>

      <!-- Flow_10: Mark Complete -> End -->
      <bpmndi:BPMNEdge id="Flow_10_di" bpmnElement="Flow_10">
        <di:waypoint x="1309" y="348"/>
        <di:waypoint x="1359" y="348"/>
      </bpmndi:BPMNEdge>

    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>

</bpmn:definitions>
