# Active Context

**Last Updated**: 2026-02-27

## Current Focus

Executing full SDLC across 106 stories (18 epics) from PRD v2.1 decomposition. Currently on Phase 1 Foundation stories.

## Recently Completed

- **PR #410 merged** — API gateway BDD tests and health endpoint enhancements (#307) (v2026.02.094)
  - Health endpoint: timestamp (UTC ISO), API_VERSION constant, router tags
  - 33 tests: 5 BDD scenario classes + structural tests
  - PR review: APPROVE, MEDIUM fixes (error handler behavioral tests, CORS assertion tightened)
- **PR #409 merged** — Evidence lifecycle state machine (#301) (v2026.02.093)
  - State machine: PENDING → VALIDATED → ACTIVE → EXPIRED → ARCHIVED
  - SHA-256 hashing, audit builder, auto-classification, retention expiry
  - 52 BDD tests, review findings addressed (UTC datetimes, docstring, typing)
- **PR #408 merged** — Evidence quality scoring engine (#300) (v2026.02.092)
  - Hill function freshness: >=0.96 at 12mo, 0.5 at 3yr, <0.5 beyond
  - PRIMARY/SECONDARY reliability, configurable engagement-level weights
  - validate_weights() with sum-to-1.0, score_evidence() with weight validation
  - 57 BDD tests, PR review findings addressed (consistency formula, completeness tests)
- **PR #407 merged** — Shelf data request workflow (#298) (v2026.02.091)
  - ShelfRequestStatus: OPEN, COMPLETE, CANCELLED; FollowUpReminder model
  - 53 BDD tests, PR review findings addressed (enum docs, server_default, priority enum)
- **PR #406 merged** — Evidence parsers with factory dispatch (#296) (v2026.02.090)
  - DocumentParser: PDF (pdfplumber), HTML (lxml with script/style stripping), TXT
  - StructuredDataParser: Excel (openpyxl), CSV, JSON
  - BpmnParser: BPMN XML (activities, flows, gateways, lanes, participants)
  - Factory dispatch by extension + MIME type, auto-classification by evidence category
  - 74 BDD tests (17 document + 15 structured + 14 BPMN + 27 factory + 1 script/style)
  - PR review: APPROVE with 2 MEDIUM fixed (script/style leakage, text/html MIME)
- **PR #405 merged** — SemanticRelationship bitemporal validity (#305) (v2026.02.089)
  - 5 bitemporal columns: asserted_at, retracted_at, valid_from, valid_to, superseded_by
  - Partial index on active relationships, CheckConstraint valid_to >= valid_from
  - 42 tests, PR review REQUEST CHANGES addressed (partial index, check constraint, field limits)
- **PR #404 merged** — SeedTerm entity schema and vocabulary store (#302) (v2026.02.088)
  - 5 term categories, 3 sources, 3 lifecycle states, self-referential merge FK
  - Unique constraint on (engagement_id, term, domain), GIN FTS index on term
  - 41 tests, PR review APPROVED (0 critical, 0 high)
- **PR #403 merged** — ConflictObject and disagreement taxonomy (#299) (v2026.02.087)
  - 6 mismatch types (sequence, role, rule, existence, io, control_gap), 3 resolution types, 3 lifecycle states
  - Composite index on (engagement_id, resolution_status), severity bounds [0.0, 1.0]
  - 39 tests, PR review APPROVED (0 critical, 0 high)
- **PR #402 merged** — EpistemicFrame and SurveyClaim entity schemas (#297) (v2026.02.086)
  - SurveyClaim: 8 probe types, 4 certainty tiers, engagement-scoped with session tracking
  - EpistemicFrame: 6 frame kinds, controlled vocabulary of 12 authority_scope roles
  - 46 tests, 100% coverage, PR review findings addressed (import ordering, engagement_id on frame)
- **PR #401 merged** — Controlled edge vocabulary with constraint validation (#295) (v2026.02.085)
  - 12 typed edge kinds (PRECEDES, TRIGGERS, etc.), source/target label constraints via ontology
  - Atomic bidirectional creation for CONTRADICTS/VARIANT_OF, acyclicity enforcement for PRECEDES/DEPENDS_ON
  - Ontology v2.0.0: 20 node types, 26 relationship types; validation CLI updated
  - 31 tests, PR review findings addressed (Cypher injection guard, atomic txn, validate.py counts)
- **PR #400 merged** — Three-dimensional confidence model schema (#294) (v2026.02.084)
  - Two-stage formula: strength/quality → min; Evidence grades A-U; Brightness BRIGHT/DIM/DARK with coherence constraint
  - 32 tests, 99% coverage, PR review APPROVED (0 critical, 0 high)
- **PRs #271-#275 merged** — Audit Phase 8: 10 CRITICALs + 28 HIGHs (v2026.02.083)
  - PR #271: Security hardening — Cypher injection, event loop, prod secrets, localStorage XSS, CF Worker XSS, DB passwords, auth scoping
  - PR #272: Data layer/API — FK indexes, Alembic imports, Neo4j deletes, rate limiting, pagination, response models
  - PR #273: N+1 performance — Batch Neo4j nodes, batch embeddings, Redis rate limiter
  - PR #274: Test/compliance — 33 new tests, GDPR erasure, audit logging, PII masking, credential encryption, CVE upgrades
  - PR #275: Frontend — ErrorBoundary, AbortControllers, stub audit, type hints
  - PR review findings addressed: plaintext config_json dual-write fixed, Neo4j delete engagement-scoped
- **PR #270 merged** — Fix macOS agent build scripts (v2026.02.078)
  - bash 3.2 compat: replaced `declare -A`, `mapfile`, subshell EXIT traps
  - Ad-hoc codesign: strip pre-existing signatures, sign outside .app context, no --timestamp
  - `@rpath` → `@loader_path` (pre-built Python binary lacks header padding for LC_RPATH)
  - CommonCrypto → CryptoKit AES.GCM (Command Line Tools SDK compat)
  - InMemoryConsentStore actor→class, optional chaining fix
  - Agent builds and launches successfully (~63 MB bundle, Python 3.12.7 embedded)
- **PR #263 merged** — Agent Swift Quality & Error Handling (v2026.02.077)
  - Converted IntegrityChecker from `@unchecked Sendable` + NSLock to Swift actor
  - Replaced fputs/NSLog with structured os.Logger/AgentLogger
  - Converted 5 IUOs to optionals in AppDelegate
  - Fixed PermissionsView timer closure (captures state ref, not self struct)
  - Added 128-char MDM engagementId validation
  - Moved MockPermissionsProvider to test target
  - Added @MainActor to AppSwitchMonitor
  - PR review: APPROVE with 2 MEDIUM (missing MDM test, pre-existing mock issue) — follow-up items
- **Import ordering fix** — stdlib before third-party in 5 bridge/taskmining files
- **PR #269 merged** — Audit Phase 6: Python Exception Handling (v2026.02.076)
  - Replaced ~58 broad `except Exception` with specific types (Neo4jError, SQLAlchemyError, RedisError, httpx.HTTPError, etc.)
  - Annotated ~55 intentionally broad handlers with `# Intentionally broad: <reason>` comments
  - Widened health check handlers for TCP-level connectivity errors
  - Added httpx.HTTPError to Camunda route handlers
  - Replaced os.path with pathlib.Path in pipeline + Visio parser
  - PR review: APPROVE — all medium suggestions addressed before merge
- **PR #262 merged** — Audit Phase 5: Final MEDIUM Remediation (v2026.02.075)
  - Fixed N+1 query in governance SLA health dashboard and alerting
  - `check_quality_sla()` now accepts optional pre-fetched `evidence_items`
  - Both `get_governance_health` and `check_and_alert_sla_breaches` batch-fetch evidence once
  - Export `KMFLOW_RELEASE_BUILD=1` in `release.sh` for downstream strict checks
  - Populated real SHA-256 checksums for python-build-standalone tarballs (aarch64 + x86_64)
  - Updated URLs from `indygreg` to `astral-sh` after repo transfer
  - PR review: APPROVE with 1 LOW (import ordering — fixed)
- **PR #258 merged** — Audit Phase 3: macOS Agent MEDIUM-Priority Improvements (v2026.02.073)
  - Periodic integrity re-verification (5-min timer) with violation callback
  - HMAC-SHA256 signed integrity manifest with per-build key; build script fixes format mismatch
  - Per-event consent guard (CaptureStateManager.isCapturePermitted)
  - Expanded L2 PII: +IBAN, file paths, UK NINO (8 patterns, was 5); try! → lazy try?
  - 20 new tests: 8 IntegrityChecker + 12 L2PIIFilter
  - ADR 001: sandbox-disabled rationale; profile customization script
  - Uninstall: /Users/Shared cleanup; step numbering fix
  - PR review: 1 HIGH (HMAC threat model doc) + 4 MEDIUM (tests, assertions, format mismatch) all fixed
- **PR #256 merged** — Audit Phase 2 PR 4: macOS Agent HIGH Security Hardening (v2026.02.072)
  - AES-256-GCM buffer encryption: Keychain key provisioning + decryption in TransparencyLogController
  - IPC socket: symlink detection + JSONSerialization-based auth handshake (fixed JSON injection in review)
  - HMAC-SHA256 consent record signing with per-install Keychain key; tampered records rejected
  - ConsentManager.onRevocation() handler pattern for cleanup wiring
  - CaptureStateManager.onStateChange() callback for monitor lifecycle
  - Content-level UI option disabled until L2+ PII filtering validated
  - kSecAttrSynchronizable on all Keychain stores (no iCloud sync)
  - Removed --deep from codesign, exposed codesign errors, isolated PYTHONPATH
  - PR review: 1 HIGH fixed (JSON injection), 2 LOW fixed (iCloud sync, var→let)
- **PR #255 merged** — Audit Phase 2 PR 3: Agent HIGH Security Hardening (v2026.02.071)
  - Hardened AgentLogger: all os_log interpolations now use `privacy: .private`
  - Added `kSecAttrAccessibleAfterFirstUnlock` + `kSecAttrSynchronizable: false` to Keychain writes
  - MDM config bounds clamping: screenshotInterval (5-3600), batchSize (1-10000), batchInterval (5-3600), idleTimeout (30-3600)
  - HTTPS-only scheme validation for KMFLOW_BACKEND_URL in PythonProcessManager
  - Removed unused `files.user-selected.read-write` entitlement
  - PR review: 1 blocking (HTTP allowed → fixed to HTTPS-only), 2 advisory (publicError variant, direct os.Logger usage)
- **PR #252 merged** — Audit Phase 2 PR 2: Missing FK Indexes (v2026.02.070)
  - Migration 029: 13 B-tree indexes on unindexed FK columns across 6 model modules
  - PR review: 1 MEDIUM fixed (removed non-FK lineage_id), 1 LOW fixed (naming suffix)
- **PR #251 merged** — Audit Phase 1: macOS Agent Build Pipeline Hardening (v2026.02.069)
  - Added --options runtime to all codesign invocations across embed-python.sh, build-app-bundle.sh, sign-all.sh
  - Refused ad-hoc signing in release.sh (defense-in-depth)
  - Pinned all 11 Python packages (4 direct + 7 transitive) with == and SHA-256 hashes
  - Added SHA-256 verification for python-build-standalone tarball downloads
  - PR review: 1 CRITICAL + 1 HIGH fixed (missing --options runtime in embed-python.sh and sign-all.sh)
- **PR #249 merged** — Audit Phase 2 PR 1: Platform Auth & API Hardening (v2026.02.068)
  - Pagination bounds on 22 limit/offset params across 10 route files (ge/le validators)
  - WebSocket engagement membership verification for monitoring + alerts endpoints
  - TOM CRUD membership checks for all 6 routes (create/list/get/update models, create/list gaps)
  - Replaced duplicate _log_audit in engagements.py with centralized log_audit
  - 2 new WebSocket auth tests, 2308 total backend tests
  - PR review: APPROVE with 2 MEDIUM (auth duplication — follow-up, get/update TOM — fixed), 3 LOW
- **PR #248 merged** — Audit Phase 1 PR 3: Agent Security (v2026.02.067)
  - Removed Apple Events entitlement, mouse x/y coordinates, nil bundleId bypass
  - Fixed signing (refuse ad-hoc for release), notarization (verify Accepted status), pip hashes
  - Removed eval injection in postinstall, rewrote plist log paths via PlistBuddy
  - Replaced Thread.sleep with Task.sleep, converted 5 @unchecked Sendable to actors
  - AES-256-GCM encryption and IPC auth documented as planned (E3-CRITICAL follow-up)
- **PR #247 merged** — Audit Phase 1 PR 2: Platform Quality (v2026.02.066)
  - Hardened RateLimitMiddleware: periodic pruning of expired entries
  - Stopped trusting X-Forwarded-For header for client IP
  - 3 new tests for pruning and X-Forwarded-For rejection
  - Note: 11 of 13 Story #243 tasks were already fixed in prior releases; CRITICAL slowapi finding was false positive
- **PR #246 merged** — Audit Phase 1 PR 1: Platform Security (v2026.02.065)
  - Wired require_engagement_access into 11 routes across 5 files
  - Removed dead verify_api_key sync stub from MCP auth
  - Fixed PIA R8 false encryption claim
  - Updated test mocks for engagement access dependency
  - Note: Routes with body-only engagement_id need follow-up
- **PR #245 merged** — Audit Phase 0: Documentation Corrections (v2026.02.064)
  - Fixed false encryption, PII layer, socket path, uninstall path claims in whitepaper
  - Corrected DPA template, PIA template with "planned" disclaimers
  - Removed ScreenCapture from TCC profile (least privilege)
  - Renamed L1Filter → CaptureContextFilter for clarity
  - Fixed "All data is encrypted" UI string in WelcomeView
  - PR review: 1 MEDIUM (PIA R8 row — will fix in Phase 1)
- **Committed to main** — CISO-ready macOS Agent Installer (v2026.02.063)
  - App bundle with embedded Python.framework, code signing, notarization pipeline
  - Security hardening: Keychain for secrets, mTLS, SHA-256 integrity manifest
  - SwiftUI onboarding wizard, transparency log, MDM profiles
  - DMG + PKG installers, LaunchAgent, uninstall script
  - GitHub Actions release pipeline (agent/v* tags)
  - Security whitepaper, DPA template, PIA template for CISO review
- **PR #236 merged** — ML Task Segmentation (Epic 8) (v2026.02.062)
  - Feature extraction (30-dim vectors), gradient boosting classifier, hybrid ML+rules, sequence mining
  - Shared app_categories module extracted to deduplicate graph_ingest + ML features
  - 63 new tests, 2306 total backend tests passing
  - PR review: 0 CRITICAL, 0 HIGH, 3 MEDIUM fixed (dead imports, code duplication, missing test)
  - Stories covered: #232-#235
- **PR #230 merged** — Knowledge Graph Integration (Epic 7) (v2026.02.061)
  - Graph ingestion, semantic bridge, LCD weight, variant detection
  - Ontology: SUPPORTS, MAPS_TO, extended DEVIATES_FROM
  - 71 new tests, 2243 total backend tests passing
  - Stories covered: #226-#229
- **PR #224 merged** — Admin Dashboard (Epic 6) (v2026.02.060)
- **PR #223 merged** — Privacy and Compliance (Epic 5) (v2026.02.059)
- **PR #222 merged** — Action Aggregation Engine (Epic 4) (v2026.02.058)
- **PR #221 merged** — macOS Desktop Agent (Epic 3) (v2026.02.057)
- **PR #220 merged** — Task Mining backend + SDLC infrastructure (v2026.02.056)

## Pending Work

- **Worker.py wiring**: Connect aggregation engine to Redis stream consumer (TODO in worker.py)
- **API endpoints**: Expose graph ingestion, semantic bridge, variant detection, ML classification via REST
- Follow-up items from PR #224: client-side role guard layout, WebSocket auth verification

## Session Notes

- 2308 backend tests + 206 frontend tests passing
- All 8 task mining epics (1-8) complete
- Phase 1 MVP + Phase 2 ML + Phase 3 graph integration implemented

